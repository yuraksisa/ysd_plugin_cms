<%= include('entity-management') %>

<!-- Renders the element description -->
<script type="text/tmpl" id="elements_title">
  <h2 class="entity-title"><%=t.content_type_management.title%></h2>
</script>

<!-- Renders the element description -->
<script type="text/tmpl" id="elements_description">
  <%= t.content_type_management.description %>
</script>

<!-- Renders the elements container -->
<script type="text/tmpl" id="elements_container_template">

  <table id="elements_table" class="table">
     <thead class="table-header">
       <tr>
         <th class="table-header-title" scope="col" style="width:25%"><%=t.content_type_management.form.name.label%></th>
         <th class="table-header-title" scope="col" style="width:75%"><%=t.content_type_management.form.description.label%></th>
       </tr>
     </thead>
     <tbody id="elements_tbody" class="table-tbody">             
     </tbody>
  </table>

</script>

<!-- Renders one element in the elements list view -->
        
<script type="text/tmpl" id="elements_list_template">

    <tr class="table-row element-navigation-detail" rel="<%%= index %>" id="element_row_<%%=index%>">
      <td class="table-cell"><%%= entity.name %></td>
      <td class="table-cell"><%%= entity.description %></td>
    </tr>

</script>

<!-- Renders one element in the element view (full detailed) -->

<script type="text/tmpl" id="element_template">

     <div class="element_template" style="overflow:hidden">
       <div class="entity-field">
         <div class="entity-fieldlabel"><%=t.content_type_management.form.id.label%></div> 
         <div class="entity-fieldvalue"><span class="entity-id"><%%= entity.id %></span></div> 
       </div>
       <div class="entity-field">
         <div class="entity-fieldlabel"><%=t.content_type_management.form.name.label%></div> 
         <div class="entity-fieldvalue"><%%= entity.name %></div> 
       </div>
       <div class="entity-field">
         <div class="entity-fieldlabel"><%=t.content_type_management.form.description.label%></div> 
         <div class="entity-fieldvalue"><%%= entity.description %></div>
       </div>
       <div class="entity-field">
         <div class="entity-fieldlabel"><%=t.content_type_management.form.message_on_new_content.label%></div> 
         <div class="entity-fieldvalue"><%%= entity.message_on_new_content %></div>
       </div>    
       <div class="entity-field">
         <div class="entity-fieldlabel"><%=t.content_type_management.form.message_on_edit_content.label%></div> 
         <div class="entity-fieldvalue"><%%= entity.message_on_edit_content %></div>
       </div>              
       <div class="entity-field">
         <div class="entity-fieldlabel"><%=t.content_type_management.form.workflow.label%></div>
         <div class="entity-fieldvalue"><%%= entity.publishing_workflow%></div>
       </div>
       <div class="entity-field">
         <div class="entity-fieldlabel"><%=t.content_type_management.form.usergroups.label%></div>
         <div class="entity-fieldvalue"><%%= self.model.entityHooks[0].formatUserGroups(entity) %></div>
       </div>
     </div>

</script>

<!-- Renders the form to edit an element -->

<script type="text/tmpl" id="element_template_form">
              
     <form name="element" id="content_type_management_form">
        
        <div class="form-fields">
        
          <div class="formrow">
            <label for="id" class="fieldtitle"><%=t.content_type_management.form.id.label%> <span class="mandatoryfield">*</span></label>
            <input type="text" maxlength="20" id="id" name="id" class="fieldcontrol" <%% if (entity) { %> value="<%%= entity.id %>" <%% } %> />
          </div>

          <div id="tabs">

            <ul>
              <%= render_tab('ctype_description', t.content_type_management.form.description_block.label) %>
              <%= render_tab('ctype_messages',  t.content_type_management.form.messages_block.label) %>
              <%= render_tab('ctype_workflow',  t.content_type_management.form.workflow_block.label) %>
              <%= render_tab('ctype_permissions', t.content_type_management.form.permissions_block.label) %>
            </ul>

            <div id="ctype_description">
              <div class="formrow">
                <label for="name" class="fieldtitle"><%=t.content_type_management.form.name.label%> <span class="mandatoryfield">*</span></label>
                <input type="text" maxlength="50" id="name" name="name" class="fieldcontrol" <%% if (entity) { %> value="<%%= entity.name %>" <%% } %> />
              </div>

              <div class="formrow">
                <label for="description" class="fieldtitle"><%=t.content_type_management.form.description.label%></label>
                <textarea name="description" id="description" class="fieldcontrol" rows="5"><%% if (entity) { %><%%=entity.description%><%% } %></textarea>
              </div>
              <p style="text-align:right"> <span id="description_length"></span> <%= t.available_chars %> </p>
            </div>

            <div id="ctype_messages">
              <div class="formrow">
                <label for="message_on_new_content" class="fieldtitle"><%=t.content_type_management.form.message_on_new_content.label%></label>
                <textarea name="message_on_new_content" id="message_on_new_content" class="fieldcontrol" rows="5"><%% if (entity) { %><%%=entity.message_on_new_content%><%% } %></textarea>
              </div>
              <p style="text-align:right"> <span id="message_on_new_content_length"></span> <%= t.available_chars %> </p>

              <div class="formrow">
                <label for="message_on_edit_content" class="fieldtitle"><%=t.content_type_management.form.message_on_edit_content.label%></label>
                <textarea name="message_on_edit_content" id="message_on_edit_content" class="fieldcontrol" rows="5"><%% if (entity) { %><%%=entity.message_on_edit_content%><%% } %></textarea>
              </div>
              <p style="text-align:right"> <span id="message_on_edit_content_length"></span> <%= t.available_chars %> </p>
            </div>

            <div id="ctype_workflow">
              <div class="formrow">
                <label for="publishing_workflow" class="fieldtitle"><%=t.content_type_management.form.workflow.label%></label>
                <select name="publishing_workflow" id="publishing_workflow" class="fieldcontrol" style="max-width:95%"/>
              </div>
            </div>

            <div id="ctype_permissions">
              <div class="formrow">
                <label class="fieldtitle"><%=t.content_type_management.form.usergroups.label%></label>
                <div id="content_type_usergroups"></div>
              </div>
            </div>

          </div>

          <!--div class="formrow">
            <div id="content_type_aspects"></div>       
          </div-->
            
          <%% if (entity) { %>
            <%= edit_element_form %>
          <%% } else { %>
            <%= new_element_form %>
          <%% } %> 

        <div class="bottom-navigation-bar navigation-bar">
             <div class="navigation-bar-nav-buttons">
                <input type="button" class="cancel-entity-button action-button entity-management-button" value="<%= t.entitymanagement.cancel%>"/>
                <%% if (entity) { %>
                  <input type="submit" class="update-entity-button action-button entity-management-button" value="<%= t.entitymanagement.update%>"/>
                <%% } 
                   else { %>
                  <input type="submit" class="create-entity-button action-button entity-management-button" value="<%= t.entitymanagement.create%>"/>
                <%% } %>
             </div>
        </div>
     
     </form>
     
</script>

<%= element_form_extension %>

<script type="text/javascript">
 
 require(['jquery', 'YSDEntityManagement', 'YSDEntityManagementComplementHooks', 'YSDRemoteDataSource', 'YSDListSelector', 'YSDForms', 'YSDSelectSelector'], function($, EntityManagement, EntityManagementComplementHooks, RemoteDataSource, ListSelector, YSDForms, SelectSelector) {
 
  function ContentTypeHook() {
 	   
    this.entityKey = function(entity) {
      return entity.id;
    }

    this.onEdit = function(entity) {
      $('#id').attr('readonly', true);
      $('#name').focus();  	
      this.configForm(entity);
    };
  
    this.onNew = function() {
  	  $('#id').focus();
  	  this.configForm(null);
    }

    this.adaptFormData = function(data) {
      
      data.aspects    = this.adaptAspects(data.aspects, data.id);
      data.usergroups = this.adaptUsergroups(data.usergroups, data.id); 
      
      console.log(data);

      return data;	
    	
    }

    this.adaptAspects = function(aspects, contentTypeId) { /* It converts from an array of string (each is an aspect) to an array of ContentTypeAspect */
      
      if (!(aspects instanceof Array)) {
        aspects = [aspects];
      }

      return aspects.map(function(value, index, array) {

         return { aspect : value,
                  content_type : { id: contentTypeId }
                };   

      });

    }

    this.adaptUsergroups = function(usergroups, contentTypeId) { /* It converts from an array of string (each is an usergroup group) to an array of ContentTypeUserGroup */
      
      if (!(usergroups instanceof Array)) {
        usergroups = [usergroups];
      }

      return usergroups.map(function(value, index, array) {

        return { usergroup: { group : value},
                 content_type: {id : contentTypeId}
               };

      });

    }

    
    this.configForm = function(entity) {

         $('#tabs').tabs().addClass("ui-tabs-vertical ui-helper-clearfix");
         $('#tabs li').removeClass("ui-corner-top").addClass("ui-corner-left");
         $('#tabs').tabs();

         // Configure the usergroups
         var ugDataSource = new RemoteDataSource('/usergroups',{id:'group', description:'name'});         
         var ugValue = [];
         if (entity && entity.usergroups) {
           ugValue = entity.usergroups.map(function(value, index, array) {
              return value.usergroup_group;
           });
         }         
         var ugSelector = new ListSelector('content_type_usergroups', 'usergroups', ugDataSource, ugValue ); 
        
         // Configure the workflows
         var wfDataSource = new RemoteDataSource('/workflows');
         var wfValue = (entity && entity.publishing_workflow)?entity.publishing_workflow:null;
         var wfSelector = new SelectSelector('publishing_workflow', wfDataSource, wfValue); 

         // Limit the text area length
         YSDForms.limit_text_area_content_size(document.getElementById('description'), 256, 
            function (content_remain) {
              document.getElementById('description_length').innerHTML = '<strong>' + content_remain + '</strong>';
            }
         );    

         // Limit the text area length
         YSDForms.limit_text_area_content_size(document.getElementById('message_on_new_content'), 1024, 
            function (content_remain) {
              document.getElementById('message_on_new_content_length').innerHTML = '<strong>' + content_remain + '</strong>';
            }
         );  


         // Limit the text area length
         YSDForms.limit_text_area_content_size(document.getElementById('message_on_edit_content'), 1024, 
            function (content_remain) {
              document.getElementById('message_on_edit_content_length').innerHTML = '<strong>' + content_remain + '</strong>';
            }
         );      	


    }

    this.configValidation = function() {

         $('#content_type_management_form').validate({
            
            submitHandler: function(form) 
            {
               return false;
            },
                               
            rules : { // rules
               'id' : {
                 required: true
               },
               'name': {
                 required: true 
               }
            },
            
            messages : { // messages
               'id' : {
                required: '<%= t.content_type_management.form.id.required%>'
               },
               'name': {
                 required : '<%=t.variable_management.form.name.required%>'
               }
            }
            
          }
         );

    }
  	
    this.formatUserGroups = function(entity) { /* Format the usergroups for the representation */
      
      var usergroups = entity.usergroups.map(function(value, index, array) {
        return value.usergroup_group;
      });
      
      return usergroups; 
    }  

  };
  
  var urls = { 
  	           query_url  : '/ctypes',
    	         create_url : '/ctype',
  	           update_url : '/ctype',
  	           delete_url : '/ctype',
  	           get_url    : '/ctype'
  	         };

  var contentTypeHook = new ContentTypeHook();

  var hooks = [contentTypeHook];
  
  // Add the complement hooks
  hooks = hooks.concat(EntityManagementComplementHooks.complements);

  var contentsTypeManager = new EntityManagement(urls, 'content type', 12, hooks);
  
 });
  
</script>
